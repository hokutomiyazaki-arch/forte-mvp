# B3: リワード設定画面 — Claude Code 実装指示書

## ⚠️ 最初にやること
1. CLAUDE.md を読む
2. このファイルを全部読む
3. 実装計画を見せる（コードはまだ書かないで）

---

## 概要

ダッシュボードのプロフィール編集フォーム（editing=true）にある
リワード設定UIを、8カテゴリ対応の新UIに改修する。

プロが8種類のリワードカテゴリから**最大3つ**を選び、各リワードの内容を入力する画面。

---

## リワードの設計思想（重要）

リワードは単なるクーポン配布ではない。**「プルーフの交換」**。

- クライアント → プロ：「この人の技術は本物だ」と投票で証明
- プロ → クライアント：「このレストランは本物に美味しい」と自分のおすすめで証明

双方が「本物を証明する」行為を交換し合う。だから値引きクーポンだけでなく、
プロの人間性や目利きが伝わるリワードが主役。

---

## 8つのリワードカテゴリ

| # | カテゴリID | 表示名 | 説明（プロ向け） | 入力フィールド |
|---|-----------|--------|-----------------|---------------|
| 1 | `coupon` | 次回特典 | 延長15分無料、オプション無料追加など（値引きではなく価値の上乗せ） | 内容テキスト |
| 2 | `secret` | プロの秘密 | あなただけが知っている専門知識やテクニック | 内容テキスト |
| 3 | `selfcare` | 自宅でできる○○ | セルフケア・セルフワークを教える（タイトルはカスタマイズ可） | タイトル + 内容テキスト |
| 4 | `book` | おすすめの一冊 | あなたの人生を変えた本 | 内容テキスト |
| 5 | `spot` | おすすめスポット | あなたの行きつけ | 内容テキスト |
| 6 | `media` | おすすめ作品 | 映画・音楽・Podcast | 内容テキスト |
| 7 | `surprise` | シークレット | 種類すら非公開！何が出るかお楽しみ | 内容テキスト |
| 8 | `freeform` | 自由記入 | 何でもOK。タイトルと内容を自由に設定 | タイトル + 内容テキスト |

### 特殊カテゴリの注意
- **シークレット**: クライアントの投票画面で「種類」すら表示されない。「シークレット — 何が出るかお楽しみ！」とだけ表示
- **自宅でできる○○ / 自由記入**: タイトルをプロがカスタマイズできる（例: 「自宅でできる肩こり解消法」）
- **それ以外**: タイトルは固定（カテゴリ名がそのままタイトル）

---

## 保存先DB

### rewards テーブル（既存）
```
id: uuid
professional_id: uuid
reward_type: text       -- カテゴリID（coupon/secret/selfcare/book/spot/media/surprise/freeform）
title: text             -- カスタムタイトル（selfcare/freeformのみ使用。それ以外はnull）
content: text           -- リワードの内容
sort_order: int         -- 表示順
created_at: timestamptz
```

### ルール
- 1プロ最大3つまで
- 同じカテゴリを複数選択不可（1カテゴリ=1リワード）
- プロがリワード未設定の場合、投票画面でリワード選択UIが非表示になる

---

## UI設計

### 配置場所
ダッシュボードの editing=true（プロフィール編集フォーム）内。
現在の「投票後のお礼リワード（最大3つ）」セクションを改修。

### レイアウト

```
┌──────────────────────────────────────────────────────┐
│ リワード設定（最大3つ）                               │
│                                                       │
│ 投票してくれたクライアントへのお礼を設定。             │
│ プロの秘密やおすすめを共有して、信頼を深めましょう。   │
│                                                       │
│ ┌─ 設定済みリワード ────────────────────────┐         │
│ │                                            │         │
│ │ ┌ 1. プロの秘密 ────────────────────┐     │         │
│ │ │ [内容を入力...                    ]│     │         │
│ │ │                            [削除] │     │         │
│ │ └───────────────────────────────────┘     │         │
│ │                                            │         │
│ │ ┌ 2. おすすめスポット ──────────────┐     │         │
│ │ │ [内容を入力...                    ]│     │         │
│ │ │                            [削除] │     │         │
│ │ └───────────────────────────────────┘     │         │
│ │                                            │         │
│ └────────────────────────────────────────────┘         │
│                                                       │
│ ┌─ リワードを追加（残り1枠）───────────────┐          │
│ │                                            │          │
│ │  ○ 次回特典                                │          │
│ │  ● プロの秘密        ← 既に設定済みは非表示│          │
│ │  ○ 自宅でできる○○                         │          │
│ │  ○ おすすめの一冊                          │          │
│ │  ○ おすすめスポット   ← 既に設定済みは非表示│          │
│ │  ○ おすすめ作品                            │          │
│ │  ○ シークレット                            │          │
│ │  ○ 自由記入                                │          │
│ │                                            │          │
│ │  [追加する]                                │          │
│ └────────────────────────────────────────────┘          │
│                                                       │
│ 設定中: ██████░░░ 2/3                                 │
└──────────────────────────────────────────────────────┘
```

### インタラクション仕様

1. **リワード追加フロー**:
   - 「リワードを追加」をタップ → カテゴリ選択UI表示（設定済みカテゴリは非表示）
   - カテゴリを選択 → 入力欄が追加される
   - selfcare/freeform はタイトル入力欄も表示
   - 3つ設定済みなら追加UIは非表示

2. **リワード編集**:
   - 各リワードの内容テキストは直接編集可能
   - selfcare/freeform はタイトルも編集可能

3. **リワード削除**:
   - 各リワードに削除ボタン
   - 確認なしで即削除（stateから消すだけ、保存ボタン押すまでDBには反映しない）

4. **保存**:
   - プロフィール全体の「保存する」ボタンで一括保存
   - rewards テーブルに upsert（既存のリワードを DELETE → INSERT）

### カテゴリ選択UIの補足
- 8カテゴリをリストで表示
- 各カテゴリ名の横に短い説明テキスト（プロ向け、グレー文字）
- 既に設定済みのカテゴリはリストから除外（重複防止）
- 3つ設定済みなら追加UI自体を非表示

---

## デザイン仕様

### カラー（REALPROOFブランド準拠）
- カード背景: White (#FFFFFF)
- カテゴリ名: Dark (#1A1A2E), font-weight: 600
- 説明テキスト: Gray (#9CA3AF)
- 入力欄: Cream背景 (#FAFAF7), フォーカス時 Gold ボーダー (#C4A35A)
- 削除ボタン: グレーテキスト、ホバーで赤
- 追加ボタン: Gold テキスト
- プログレス: B2と同じスタイル（X/3）
- **絵文字は使わない**

---

## エッジケース

| ケース | 対応 |
|--------|------|
| リワード0個で保存 | OK（投票画面でリワード選択が非表示になるだけ） |
| 同じカテゴリを重複追加 | 設定済みカテゴリは選択肢から除外して防止 |
| 内容が空のまま保存 | 空のリワードは保存しない（除外） |
| selfcare/freeform でタイトル空 | デフォルトタイトルを使用（「自宅でできる○○」「自由記入」） |
| rewardsテーブルにRLSが未設定 | SELECT/INSERT/UPDATE/DELETE ポリシーを確認 |

---

## 既存コードとの関係

現在 editing=true 内に「投票後のお礼リワード（最大3つ）」のUIが既にある（L500-552付近）。
これを改修して8カテゴリ対応にする。

### 確認すべきこと
- rewards テーブルの現在のスキーマ（reward_type カラムの CHECK 制約など）
- 既存のリワード保存ロジック（handleSave内）
- rewards テーブルの RLS ポリシー

---

## 実装上の注意

1. dashboard/page.tsx の editing=true セクション内を改修
2. `getSession()` を使う（`getUser()` 禁止）
3. `.maybeSingle()` を使う（`.single()` 禁止）
4. Tailwind CSS でスタイリング
5. 保存後に `npm run build` 確認
6. 完了後 main にマージして push

---

## テスト確認項目

- [ ] 8カテゴリがリストに表示される
- [ ] カテゴリ選択 → 入力欄が追加される
- [ ] 3つ設定したら追加UIが非表示になる
- [ ] 設定済みカテゴリが選択肢から消える
- [ ] selfcare/freeform でタイトル入力欄が表示される
- [ ] 削除ボタンでリワードが消える
- [ ] 保存 → リロード → リワードが復元される
- [ ] npm run build が通る
