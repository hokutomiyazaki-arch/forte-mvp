# C2: 投票完了→リワード導線 改修 — Claude Code 実装指示書

## ⚠️ 最初にやること
1. CLAUDE.md を読む
2. このファイルを全部読む
3. 実装計画を見せる（コードはまだ書かないで）

---

## 概要

投票確認後のフロー（vote-confirmed画面）を全面改修する。
現在はURLパラメータでリワード情報を渡しているが、
ページ遷移やリロードでデータが消える問題がある。
DBからリワード情報を直接取得する設計に変更する。

### 修正ポイント
1. **リワード情報をDBから取得**（URLパラメータ依存をやめる）
2. **アカウント登録後にリワード内容を即表示**
3. **client_rewardsテーブルへの保存を整理**
4. **クライアントのmycardにメールアドレス表示を追加**

---

## 現在の問題

### 問題1: リワード情報がURLパラメータ依存
- confirm-vote/route.ts がリダイレクト時にURLにreward_type, reward_title等を付与
- vote-confirmed/page.tsx がURLパラメータから読み取って表示
- → ページ遷移やリロードでデータが消える
- → アカウント登録後に戻ってきた時にリワードが表示されない

### 問題2: アカウント登録後のリワード表示
- 「リワードをコレクションする」→ /login → アカウント作成 → /mycard
- mycardに遷移した時、受け取ったリワードの内容が見えない

### 問題3: クライアントのメアド非表示
- mycardページに自分のメールアドレスが表示されていない

---

## 修正設計

### A. vote-confirmed画面の改修

**現在のフロー:**
```
メール確認リンク → confirm-vote API → URLパラメータ付きリダイレクト → vote-confirmed表示
```

**新しいフロー:**
```
メール確認リンク → confirm-vote API → vote_idをURLに付与 → vote-confirmed がDBから直接取得
```

**confirm-vote/route.ts の変更:**
- リダイレクトURLを簡素化: `?pro=xxx&vote_id=yyy` のみ
- reward_type, reward_title, reward_content 等のパラメータを削除

**vote-confirmed/page.tsx の変更:**
- URLから `vote_id` を取得
- `votes` テーブルから vote_id で投票データを取得
- `selected_reward_id` があれば `rewards` テーブルからリワード詳細を取得
- リワード内容をDBから直接表示

**表示パターン:**

パターン1: リワードあり + 未ログイン
```
┌──────────────────────────────────────┐
│                                       │
│      プルーフが確定しました！          │
│  〇〇さんにあなたのプルーフが届きました│
│                                       │
│  ┌─────── リワード ──────────┐        │
│  │                            │        │
│  │  🎁 おすすめスポット       │        │
│  │  「渋谷の隠れ家イタリアン  │        │
│  │   トラットリアXXX」        │        │
│  │                            │        │
│  └────────────────────────────┘        │
│                                       │
│  ┌────────────────────────────┐       │
│  │ リワードをコレクションする  │       │
│  │ アカウント登録で保存できます │       │
│  └────────────────────────────┘       │
│                                       │
│  [ 〇〇さんのカードを見る ]           │
│                                       │
└──────────────────────────────────────┘
```

パターン2: リワードあり + ログイン済み
```
┌──────────────────────────────────────┐
│                                       │
│      プルーフが確定しました！          │
│  〇〇さんにあなたのプルーフが届きました│
│                                       │
│  ┌─────── リワード ──────────┐        │
│  │                            │        │
│  │  🎁 おすすめスポット       │        │
│  │  「渋谷の隠れ家イタリアン  │        │
│  │   トラットリアXXX」        │        │
│  │                            │        │
│  └────────────────────────────┘        │
│                                       │
│  ✅ リワードをコレクションに保存しました│
│                                       │
│  [ マイカードを見る ]                 │
│  [ 〇〇さんのカードを見る ]           │
│                                       │
└──────────────────────────────────────┘
```

パターン3: リワードなし
```
┌──────────────────────────────────────┐
│                                       │
│      プルーフが確定しました！          │
│  〇〇さんにあなたのプルーフが届きました│
│                                       │
│  [ 〇〇さんのカードを見る ]           │
│                                       │
└──────────────────────────────────────┘
```

パターン4: シークレットリワード + 未ログイン
```
┌──────────────────────────────────────┐
│                                       │
│      プルーフが確定しました！          │
│  〇〇さんにあなたのプルーフが届きました│
│                                       │
│  ┌─────── リワード ──────────┐        │
│  │                            │        │
│  │  🎁 シークレット           │        │
│  │  「（プロからの秘密の       │        │
│  │    メッセージ）」           │        │
│  │                            │        │
│  └────────────────────────────┘        │
│                                       │
│  ┌────────────────────────────┐       │
│  │ リワードをコレクションする  │       │
│  └────────────────────────────┘       │
│                                       │
└──────────────────────────────────────┘
```

### B. client_rewards テーブルの保存

**保存タイミング:**
- confirm-vote API実行時（プルーフ確定時）に client_rewards へ INSERT
- ログイン有無に関係なく、投票確定時点で保存
- voter_email をキーにして、後からアカウントと紐づけ

**client_rewards の保存データ:**
```
{
  vote_id: uuid,
  reward_id: uuid,          -- rewards テーブルのID
  professional_id: uuid,
  client_email: string,      -- 投票時のメール
  status: 'pending',         -- pending / used
  created_at: timestamp
}
```

### C. mycardページの改修

**追加1: メールアドレス表示**
- ページ上部にログイン中のメールアドレスを表示
- `getSession()` から取得

**追加2: リワード一覧の表示改善**
- client_rewards テーブルから、そのユーザーのメールに紐づくリワードを取得
- rewards テーブルと JOIN して、カテゴリ名・タイトル・内容を表示
- プロの名前も表示（professionals テーブル JOIN）

---

## DB変更

### client_rewards テーブルの確認
既存のテーブル構造を確認して、以下のカラムがあるか確認:
- vote_id
- reward_id
- professional_id
- client_email
- status (pending/used)
- used_at
- created_at

不足があればALTER TABLEで追加。

---

## デザイン仕様

### vote-confirmed画面
- ページ背景: Cream (#FAFAF7)
- リワードカード: White背景、Goldボーダー（点線）
- リワードカテゴリ名: Dark (#1A1A2E), 小さめ
- リワード内容: Dark, font-weight: 600, 大きめ
- 「コレクションする」ボタン: Gold背景, White テキスト
- 「カードを見る」ボタン: Dark背景, White テキスト
- 絵文字は使わない

### mycard画面
- メールアドレス: グレーテキスト、ページ上部
- リワードカード: 既存デザインを踏襲

---

## エッジケース

| ケース | 対応 |
|--------|------|
| vote_id がURLにない（旧URLでアクセス） | URLパラメータからフォールバック取得 |
| リワード未選択で投票 | リワードセクション非表示 |
| プロがリワードを後から削除 | rewards テーブルに残っていなければ「リワードは利用できません」表示 |
| 同じvote_idで複数回アクセス | 問題なし（SELECT のみ） |
| client_rewards に既にレコードがある場合 | 重複INSERT防止（UNIQUE制約 or ON CONFLICT） |

---

## 実装上の注意

1. vote-confirmed/page.tsx は大幅改修
2. confirm-vote/route.ts のリダイレクトURL簡素化
3. mycard/page.tsx にメアド表示追加
4. `getSession()` を使う（`getUser()` 禁止）
5. `.maybeSingle()` を使う（`.single()` 禁止）
6. 保存後に `npm run build` 確認
7. 完了後 main にマージして push
8. Supabaseで実行が必要なSQLがあれば中身を見せて

---

## テスト確認項目

- [ ] 新しい投票 → メール確認 → vote-confirmed でリワード内容がDB から表示される
- [ ] ページリロードしてもリワードが消えない
- [ ] リワード未選択の投票 → リワードセクション非表示
- [ ] 未ログインで「コレクションする」→ ログイン画面
- [ ] ログイン後 → mycard でリワードが見える
- [ ] mycard にメールアドレスが表示される
- [ ] npm run build が通る
