# C1: 投票画面改修 — Claude Code 実装指示書

## ⚠️ 最初にやること
1. CLAUDE.md を読む
2. このファイルを全部読む
3. 実装計画を見せる（コードはまだ書かないで）

---

## 概要

投票画面（vote/[id]/page.tsx または vote/[qr_token]/page.tsx）を全面改修する。
クライアントがQRコードをスキャンした後に表示される、REALPROOFで最も重要な画面。

### 変更のポイント
1. **アコーディオン化**: 心理的負荷を減らす。項目がズラッと並ばない
2. **セッション回数セレクター**: 初回と継続の投票を区別
3. **プロが設定した項目を表示**: proof_itemsテーブルから動的に取得
4. **「特にない」を削除**: 0〜3つ選べるので不要
5. **「期待できそう！」は残す**: 固定項目として表示

---

## 投票画面の全体フロー

```
QRスキャン → プロのプロフィール表示（ログイン不要）
  ↓
「投票する」ボタン
  ↓
┌──────────────────────────────────────┐
│                                       │
│  〇〇さんのセッションは？             │  ← セッション回数（必須）
│   ● 1回目   ○ 2回目以降              │
│                                       │
│  ▶ 強みプルーフ（0/3）               │  ← アコーディオン（タップで展開）
│                                       │
│  ▶ 人柄プルーフ（0/3）               │  ← アコーディオン（タップで展開）
│                                       │
│  ひとことコメント（任意）             │
│  [                                  ] │
│                                       │
│  メールアドレス                       │
│  [                                  ] │
│                                       │
│  ▶ リワードを選ぶ（0/1）             │  ← アコーディオン
│                                       │
│  [投票する]                           │
│                                       │
└──────────────────────────────────────┘
  ↓
投票完了 → リワード開示 → アカウント作成促進（C2で実装）
```

---

## セクション詳細

### 1. セッション回数セレクター（画面の一番上）

**UIイメージ:**
```
┌──────────────────────────────────────┐
│  〇〇さんのセッションは？             │
│                                       │
│  ┌─────────────┐ ┌─────────────┐     │
│  │   1回目      │ │  2回目以降   │     │
│  └─────────────┘ └─────────────┘     │
└──────────────────────────────────────┘
```

- 〇〇 = プロの名前（professionals.name）
- 2つのボタン形式（ラジオボタンではなくカード型ボタン）
- **必須**: 選択しないと投票ボタンがdisabled
- デフォルト: 未選択
- 選択時: Goldボーダー + Goldテキスト

**DB保存:**
```sql
-- 事前にSupabaseで実行が必要
ALTER TABLE votes ADD COLUMN IF NOT EXISTS
  session_count TEXT DEFAULT 'first' CHECK (session_count IN ('first', 'repeat'));
```

**スコアリング（将来のactive_ranking計算用）:**
- first = 0.5票
- repeat = 1票
- 「期待できそう！」= 0.5票
- これらは独立（掛け算ではない）

---

### 2. 強みプルーフ（アコーディオン）

**閉じた状態:**
```
┌──────────────────────────────────────┐
│  ▶ 強みプルーフ（0/3）     [任意]    │
└──────────────────────────────────────┘
```

**開いた状態:**
```
┌──────────────────────────────────────┐
│  ▼ 強みプルーフ（1/3）     [任意]    │
│                                       │
│  ☐ 痛みを取る技術がある              │  ← プロが設定した9項目
│  ☑ 動きを変える技術がある            │     （proof_items + custom_proofs）
│  ☐ 根本原因にアプローチできる        │
│  ☐ 身体の変化を実感させてくれる      │
│  ☐ 原因を見抜く力がある              │
│  ☐ 結果を出すのが早い                │
│  ☐ 他では得られない体験だった        │
│  ☐ 神経科学でアプローチできる        │  ← カスタム項目
│  ☐ 人生が変わった                    │
│  ─────────────────────────────       │
│  ☐ 期待できそう！                    │  ← 固定項目（0.5票）
│                                       │
│  ※ 期待できそう！を選ぶと他の        │
│    項目は選択できません               │
└──────────────────────────────────────┘
```

**表示する項目:**
1. プロが設定した9項目（professionals.selected_proofs + custom_proofs）
   - selected_proofs の id で proof_items テーブルからラベルを取得
   - custom_proofs の label をそのまま表示
2. 固定項目「期待できそう！」（区切り線の下に表示）

**選択ルール:**
- 最大3つまで選択可能
- 0個でもOK（任意）
- 「期待できそう！」を選ぶと他の項目はグレーアウト（排他）
- 他の項目を1つでも選ぶと「期待できそう！」はグレーアウト（排他）

---

### 3. 人柄プルーフ（アコーディオン）

**閉じた状態:**
```
┌──────────────────────────────────────┐
│  ▶ 人柄プルーフ（0/3）     [任意]    │
└──────────────────────────────────────┘
```

**開いた状態:**
```
┌──────────────────────────────────────┐
│  ▼ 人柄プルーフ（1/3）     [任意]    │
│                                       │
│  ☐ 安心して任せられる                │  ← personality_items テーブルから
│  ☑ 話しやすい                        │
│  ☐ 情熱がある                        │
│  ☐ よく見てくれる                    │
│  ☐ 説明がわかりやすい                │
│  ☐ 話をしっかり聴いてくれる          │
│  ☐ 前向きにしてくれる                │
│  ☐ 厳しさの中に愛がある              │
│  ☐ 知識が豊富                        │
│  ☐ プロフェッショナル                │
└──────────────────────────────────────┘
```

**表示する項目:**
- personality_items テーブルから全10項目を取得
- 排他制御なし（好きなだけ0〜3個選べる）

**選択ルール:**
- 最大3つまで選択可能
- 0個でもOK（任意）

---

### 4. ひとことコメント

```
┌──────────────────────────────────────┐
│  ひとことコメント（任意）             │
│  ┌──────────────────────────────┐    │
│  │                              │    │
│  └──────────────────────────────┘    │
│  0/100                               │
└──────────────────────────────────────┘
```

- textarea、最大100字
- 文字カウント表示
- 任意

---

### 5. メールアドレス

```
┌──────────────────────────────────────┐
│  メールアドレス *                     │
│  [                                  ] │
│  ※ 投票の認証に使用します             │
└──────────────────────────────────────┘
```

- 必須
- メール形式バリデーション
- パスワード不要

---

### 6. リワード選択（アコーディオン）

**プロがリワード未設定の場合:** このセクション自体を非表示

**閉じた状態:**
```
┌──────────────────────────────────────┐
│  ▶ リワードを選ぶ（0/1）   [任意]    │
└──────────────────────────────────────┘
```

**開いた状態:**
```
┌──────────────────────────────────────┐
│  ▼ リワードを選ぶ（1/1）            │
│                                       │
│  ○ プロの秘密                        │  ← 種類だけ表示（内容は非公開）
│  ● おすすめスポット                  │
│  ○ シークレット — 何が出るかお楽しみ！│  ← シークレットは特別な表示
│                                       │
│  ※ リワードの内容は投票後に開示されます│
└──────────────────────────────────────┘
```

**表示する項目:**
- rewards テーブルからプロが設定したリワード（最大3つ）
- 表示するのは「カテゴリ名（種類）」のみ。内容（content）は非公開
- **シークレット**: 「シークレット — 何が出るかお楽しみ！」と表示
- ラジオボタンで1つだけ選択
- 0個でもOK（任意）

---

### 7. 投票ボタン

```
┌──────────────────────────────────────┐
│                                       │
│  [ 投票する ]                         │
│                                       │
└──────────────────────────────────────┘
```

**enabled条件:**
- セッション回数を選択済み
- メールアドレスが入力済み＆有効な形式
- （強み・人柄・コメント・リワードは全て任意なのでバリデーション不要）

**disabled時:**
- グレーアウト + 「セッション回数とメールアドレスを入力してください」テキスト

---

## アコーディオンの共通仕様

- **デフォルト**: 全て閉じた状態
- **開閉**: ヘッダーをタップで切り替え
- **アイコン**: ▶（閉） / ▼（開）
- **ヘッダー右側**: 選択カウント（0/3）+ 「任意」バッジ
- **アニメーション**: 開閉時にスムーズなスライド（max-height transition）
- **複数同時オープン**: OK（1つ開いたら他が閉じるわけではない）

---

## DB変更（Supabaseで実行が必要）

```sql
-- votes テーブルに session_count カラムを追加
ALTER TABLE votes ADD COLUMN IF NOT EXISTS
  session_count TEXT DEFAULT 'first' CHECK (session_count IN ('first', 'repeat'));
```

---

## 投票データの保存

votes テーブルへの INSERT 時に以下を保存:

| カラム | 値 |
|--------|---|
| professional_id | プロのID |
| client_email | 入力されたメールアドレス |
| session_count | 'first' or 'repeat' |
| vote_type | 'proof' / 'hopeful' / 'personality_only' |
| proof_item_id | 選択された強みプルーフのID（複数投票なら複数行） |
| personality_item_id | 選択された人柄プルーフのID |
| comment | ひとことコメント |
| selected_reward_id | 選択されたリワードのID |
| qr_token | QRトークン |

**注意**: 現在のvotesテーブルのスキーマを確認して、必要なカラムが足りなければALTER TABLEを追加すること。

---

## デザイン仕様

### カラー
- ページ背景: Cream (#FAFAF7)
- アコーディオンヘッダー: White背景、Darkテキスト
- アコーディオン開いた中身: White背景
- チェックボックス選択時: Gold (#C4A35A)
- セッション回数ボタン選択時: Goldボーダー + Dark背景
- 「任意」バッジ: グレー背景、小さいテキスト
- 投票ボタン: Dark背景, Gold テキスト
- disabled投票ボタン: グレー背景
- 区切り線（期待できそう！の上）: 薄いグレー

### トーン
- プレミアム・プロフェッショナル
- ホットペッパーの対極
- 絵文字は使わない

---

## エッジケース

| ケース | 対応 |
|--------|------|
| プロが proof を未設定（selected_proofs が空） | 強みプルーフセクションに「期待できそう！」だけ表示 |
| プロがリワードを未設定 | リワードセクション自体を非表示 |
| 同じメールで同じプロに2回目の投票 | エラーメッセージ（UNIQUE制約） |
| QRトークンが無効/期限切れ | エラーページ表示 |
| メールアドレスがプロ自身のもの | 自己投票防止エラー |
| 全部任意で何も選ばずに投票 | OK（セッション回数+メールだけで投票可能） |

---

## 実装上の注意

1. vote/[id]/page.tsx または vote/[qr_token]/page.tsx を改修
2. `getSession()` は不要（投票はログインなしでできる）
3. proof_items と personality_items と rewards をプロのIDで取得
4. professionals テーブルから selected_proofs と custom_proofs を取得
5. Tailwind CSS でスタイリング
6. 保存後に `npm run build` 確認
7. 完了後 main にマージして push
8. Supabaseで実行が必要なSQLがあれば中身を見せて

---

## テスト確認項目

- [ ] セッション回数の2ボタンが動作する
- [ ] アコーディオンの開閉が動作する
- [ ] プロが設定した9項目が強みプルーフに表示される
- [ ] 「期待できそう！」が区切り線の下に表示される
- [ ] 排他制御が動作する（期待できそう！↔ 他の項目）
- [ ] 人柄プルーフ10項目が表示される
- [ ] 強み・人柄ともに最大3つまで選択制限
- [ ] リワード未設定時にリワードセクションが非表示
- [ ] セッション回数未選択 + メール未入力 → 投票ボタンdisabled
- [ ] 投票完了後にデータがDBに保存される
- [ ] npm run build が通る
